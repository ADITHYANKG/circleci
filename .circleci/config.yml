android-build:
  docker:
    - image: cimg/android:2023.09-node
  resource_class: large # remove this if on free plan
  working_directory: ~/project
  environment:
    GRADLE_OPTS: "-Xmx1500m -Dorg.gradle.workers.max=1 -Dorg.gradle.daemon=false"
  steps:
    - checkout
    - run:
        name: Install Ninja
        command: sudo apt-get update && sudo apt-get install -y ninja-build
    - run:
        name: Disable AAPT2 Daemon
        command: echo "android.enableAapt2Daemon=false" >> android/gradle.properties
    - restore_cache:
        keys:
          - node-modules-{{ checksum "package-lock.json" }}
    - run: npm install
    - save_cache:
        paths:
          - node_modules
        key: node-modules-{{ checksum "package-lock.json" }}
    - restore_cache:
        keys:
          - gradle-cache-{{ checksum "android/build.gradle" }}
    - run:
        name: Build Android app
        command: cd android && ./gradlew assembleDebug --console=plain --info
        no_output_timeout: 30m
    - save_cache:
        paths:
          - ~/.gradle
        key: gradle-cache-{{ checksum "android/build.gradle" }}
    - store_artifacts:
        path: android/app/build/outputs/apk/debug
        destination: android-apk
